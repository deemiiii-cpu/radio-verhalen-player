<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Zgomot Playback (with m4a)</title>
  <style>
    button {
      margin: 5px;
      padding: 10px 15px;
      font-size: 16px;
    }
    #nowPlaying {
      margin-top: 10px;
      font-weight: bold;
      font-family: sans-serif;
    }
  </style>
</head>
<body>
  <h2>Zgomot Playback</h2>
  <p>Luister naar de 10 nieuwste verhalen (.mp3, .webm, .m4a). Elk verhaal wordt maximaal 10 minuten afgespeeld. Nieuwe uploads worden automatisch opgepikt.</p>

  <div id="controls" style="display:none;">
    <button id="prev">⏮️ Vorige</button>
    <button id="play">▶️ Speel</button>
    <button id="pause">⏸️ Pauzeer</button>
    <button id="stop">⏹️ Stop</button>
    <button id="next">⏭️ Volgende</button>
    <div id="nowPlaying"></div>
  </div>

  <button id="startPlayback">Laad en Start Speler</button>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <script>
    const SUPABASE_URL = 'https://grumsinwfuekqndldunj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdydW1zaW53ZnVla3FuZGxkdW5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1NzU1MTAsImV4cCI6MjA2MTE1MTUxMH0.fRi83KSLnP-pOgBpQOqGy4IR0392VPawdSQcTIR3zkM';
    const BUCKET = 'audio-uploads';
    const MAX_DURATION = 10 * 60 * 1000;
    const MAX_TRACKS = 10;

    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const audio = new Audio();
    let current = 0;
    let trackList = [];
    let timeoutId = null;

    document.getElementById('startPlayback').addEventListener('click', async () => {
      document.getElementById('startPlayback').style.display = 'none';
      document.getElementById('controls').style.display = 'block';
      await loadTracks();
    });

    document.getElementById('play').addEventListener('click', () => {
      if (audio.src) {
        audio.play();
      } else {
        playTrack(current);
      }
    });

    document.getElementById('pause').addEventListener('click', () => {
      audio.pause();
    });

    document.getElementById('stop').addEventListener('click', () => {
      audio.pause();
      audio.currentTime = 0;
    });

    document.getElementById('next').addEventListener('click', () => {
      current = (current + 1) % trackList.length;
      playTrack(current);
    });

    document.getElementById('prev').addEventListener('click', () => {
      current = (current - 1 + trackList.length) % trackList.length;
      playTrack(current);
    });

    async function loadTracks() {
      const { data, error } = await client
        .storage
        .from(BUCKET)
        .list('', { limit: 100 });

      if (error || !data) {
        console.error('Kon audiobestanden niet laden:', error);
        document.body.innerHTML += "<p>Fout bij laden van audiobestanden.</p>";
        return;
      }

      console.log("Alle bestanden in bucket:", data.map(f => f.name));

      data.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
      trackList = data
        .filter(file =>
          file.name.toLowerCase().endsWith('.mp3') ||
          file.name.toLowerCase().endsWith('.webm') ||
          file.name.toLowerCase().endsWith('.m4a')
        )
        .slice(0, MAX_TRACKS)
        .map(file => ({
          name: file.name,
          url: `${SUPABASE_URL}/storage/v1/object/public/${BUCKET}/${encodeURIComponent(file.name)}`
        }));

      console.log("Gefilterde audiotracks:", trackList.map(t => t.name));

      current = 0;

      if (trackList.length > 0) {
        document.getElementById('nowPlaying').innerText = `Aantal geladen tracks: ${trackList.length}`;
        playTrack(current);
      } else {
        document.getElementById('nowPlaying').innerText = "Geen ondersteunde bestanden gevonden (.mp3, .webm, .m4a).";
      }
    }

    function playTrack(index) {
      if (timeoutId) clearTimeout(timeoutId);
      if (!trackList[index]) return;

      const track = trackList[index];
      audio.src = track.url;
      audio.load();
      audio.play().catch(console.error);

      document.getElementById('nowPlaying').innerText = `Now Playing: ${track.name}`;
      console.log("Now Playing:", track.url);

      timeoutId = setTimeout(() => {
        current++;
        handleTrackEnd();
      }, MAX_DURATION);

      audio.onended = () => {
        current++;
        handleTrackEnd();
      };
    }

    async function handleTrackEnd() {
      if (current >= trackList.length) {
        console.log("Alle tracks afgespeeld — nieuwe proberen op te halen.");
        await loadTracks();
      } else {
        playTrack(current);
      }
    }
  </script>
</body>
</html>
